{"componentChunkName":"component---src-templates-post-page-js","path":"/2019/02-08/mini-program-usage-experience-for-finger","result":{"data":{"prevPost":null,"nextPost":{"id":"30f984f2-e95b-5270-8340-3d87b38090cf","fields":{"slug":"/2019/03-01/deploy-your-own-npm-registry"},"excerpt":"当公司到达一定程度，为了提高前端的开发效率，公司内部会创造一系列的框架或者工具库。这些包肯定是不可以暴露到外网之外的，所以你可以搭建一个私有的 npm。如果你们公司较为富有，其实直接用 npm 的企业版也是很不错的。","timeToRead":8,"frontmatter":{"title":"搭建私有npm镜像","cover":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABDklEQVQoz5VSTUtCQRT1l6iLl/qs8M37yPJpGn4U4saVCFFotRFaWBC4KAgU3bVtEfpTT+fGKINkjYvDmbn3vPPOzJ1ELmphg7CJrGYbbLSGR8LcZA3TA43MFq/XpnanofnXQtiARxxxrTRLTdbCVgldNtPRJXpBFVN1iokq4cM7wdiPf/hNnWGsYszY6/vnSFHr/mWYZzNJ0Z1fQZemI7+MR5p1ghreaXIVXOCevSeaDshimLcxHFL8yjQrL8QzP27T8NOL8MLEX6wtCStDuQ+HHId13PBIknShipgz3QPTXrMmuGW9TI1jO2URSlLBIffHOrkJZ98py2XLcTL6mbi6tq5bTfm/B/6bwTa+ActaTpmOpy+iAAAAAElFTkSuQmCC","aspectRatio":2.4,"src":"/static/034e6cdf9b365f259ac282fb9e597878/57599/cover.png","srcSet":"/static/034e6cdf9b365f259ac282fb9e597878/c0acf/cover.png 300w,\n/static/034e6cdf9b365f259ac282fb9e597878/5c50c/cover.png 600w,\n/static/034e6cdf9b365f259ac282fb9e597878/57599/cover.png 1200w","sizes":"(max-width: 1200px) 100vw, 1200px"}}},"date":"Mar 1","author":{"id":"blackcater","nickname":"blackcater","avatar":{"childImageSharp":{"resize":{"src":"/static/3e72cc359750952f52e27f3b2a59a0ff/c0e17/blackcater.png"}}}}}},"post":{"id":"b7056da1-8c2a-5c7c-81ea-0fd3b269adae","fields":{"slug":"/2019/02-08/mini-program-usage-experience-for-finger"},"html":"<blockquote>\n<p>小程序已经有 1 年多时间了吧！从刚出来我就在关注，当时小程序写个组件，需要使用 <code class=\"language-text\">&lt;template is=&quot;&quot; data=&quot;&quot; /&gt;</code> 这样的形式来复用组件。非常的不直观。从 1.6.3 之后，小程序已经支持了新的<a href=\"https://mp.weixin.qq.com/debug/wxadoc/dev/framework/custom-component/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">自定义组件</a>的方式，这也使得小程序的开发更为简单了。依托于微信强大的用户数量，微信小程序很有可能成为新的一端（前端，iOS 端，Android 端）。</p>\n</blockquote>\n<p align=\"center\"><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 258px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAMCBQH/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAQP/2gAMAwEAAhADEAAAAexHyE06bK57kFQf/8QAGxABAAIDAQEAAAAAAAAAAAAAAQACAxESITH/2gAIAQEAAQUCvbUrkg+ZRtU66r8TcKjA0f/EABgRAQADAQAAAAAAAAAAAAAAAAECERIg/9oACAEDAQE/AQjm3j//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAcEAABAwUAAAAAAAAAAAAAAAAAARFBAhAgIWH/2gAIAQEABj8C4as0iVLGDIf/xAAZEAADAQEBAAAAAAAAAAAAAAAAARExIVH/2gAIAQEAAT8h2twLepcpfqUcPYpxZ6x7SSgnRZopSIkf/9oADAMBAAIAAwAAABCgwAD/xAAWEQEBAQAAAAAAAAAAAAAAAAABICH/2gAIAQMBAT8Qck2P/8QAFREBAQAAAAAAAAAAAAAAAAAAASD/2gAIAQIBAT8QVGP/xAAfEAEAAgICAgMAAAAAAAAAAAABABEhQTFRYXGB0fD/2gAIAQEAAT8QtWhG65W9+PuI0lPAgt1edQCUNi9zEqg6tzj4hAQ5Ta2a1+Ccihw3VxIRns5rqAgtCYPUHkKgJ//Z&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"miniprogram\" title=\"miniprogram\" src=\"/static/244efb1ff2281d6c10bad29f3de5a067/e1cf4/miniprogram.jpg\" srcset=\"/static/244efb1ff2281d6c10bad29f3de5a067/e1cf4/miniprogram.jpg 258w\" sizes=\"(max-width: 258px) 100vw, 258px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span></p>\n<p align=\"center\"><strong>&#x5FAE;&#x4FE1;&#x626B;&#x63CF;&#x1F446;&#x4E8C;&#x7EF4;&#x7801;&#xFF0C;&#x7ACB;&#x5373;&#x67E5;&#x770B;&#x6548;&#x679C;</strong></p>\n<h2 id=\"技术选型\" style=\"position:relative;\"><a href=\"#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B\" aria-label=\"技术选型 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>技术选型</h2>\n<p>很早之前体验过小程序，其极差开发体验和极低的效率一直被我诟病。但是很久已经没有关注小程序了。所以这次接到需求之后，首先进行了一些调研，希望可以让自己开发体验和开发效率变高的解决方案。</p>\n<p>有一个项目进入了眼帘：<a href=\"https://github.com/Tencent/wepy\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">wepy</a>。这个项目由腾讯团队维护，是一个让小程序支持组件化开发的框架，有着类似于 vue 的写法等等优点。听上去十分不错是不是？这种有着 vue 写法的开源项目也有许多，比方说 <a href=\"https://github.com/alibaba/weex\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">weex</a>。然而 weex 是完全是 vue 的写法。wepy 只是<strong>类似</strong>。<strong>类似</strong>就意味着有些许的不同，可能会让你感到意想不到，因为需求紧迫，无法确保接入后不会影响自己的工期，并且 wepy 本身在打包之后也会占用体积，最终要的是现在小程序已经支持了<a href=\"https://mp.weixin.qq.com/debug/wxadoc/dev/framework/custom-component/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">自定义组件</a>功能，体验也还不错，所以感觉并没有需要接入 wepy 的必要。</p>\n<p>因此最后，我们没有用任何框架来写小程序，虽然其间也遇到了一些开发上体验不好的地方，但我们通过另一中方式解决了（后面会介绍）。</p>\n<h2 id=\"核心功能\" style=\"position:relative;\"><a href=\"#%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD\" aria-label=\"核心功能 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>核心功能</h2>\n<p>“Finger 音乐课堂” 小程序（以下简称小程序）功能还是比较完整的。从用户登录，商品信息查看，支付到看回放或者直播，整个小程序可以说就是一个缩水版的 app。下面我会讲解小程序中核心的部分</p>\n<h3 id=\"登录\" style=\"position:relative;\"><a href=\"#%E7%99%BB%E5%BD%95\" aria-label=\"登录 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>登录</h3>\n<p>为何把登录放在第一个总结呢？是因为每个小程序都会有登录，并且只有登录了，你才能拿到用户的基本信息（昵称，性别，城市，openid 以及 unionid）。而手机号等其他信息，你需要特殊处理。</p>\n<h4 id=\"openid-和-unionid\" style=\"position:relative;\"><a href=\"#openid-%E5%92%8C-unionid\" aria-label=\"openid 和 unionid permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>openid 和 unionid</h4>\n<p>在讲解登录具体细节之前，我先讲解一下什么是 openid 和 unionid。openid 就相当于用户的 userId，可以唯一标识用户。发服务通知时需要 openid 来指定发给哪个用户。unionid 也可以唯一标识用户。微信有许多服务，比如说 微信第三方登录，服务号，小程序等。他们是不同的服务，同一个用户使用不同服务，微信所返回的 openid 是不一样的。但是如果你将这些服务在微信开放平台进行绑定，那么这些服务还会返回一个 unionid，这个值是相同的。有了 unionid 你才能打通自己 app 内的服务逻辑。</p>\n<h4 id=\"wxlogin-和-wxgetuserinfo\" style=\"position:relative;\"><a href=\"#wxlogin-%E5%92%8C-wxgetuserinfo\" aria-label=\"wxlogin 和 wxgetuserinfo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>wx.login 和 wx.getUserInfo</h4>\n<p>只是做一个简单的小程序，我想大家肯定都用过 <code class=\"language-text\">wx.getUserInfo</code>。但是 <code class=\"language-text\">wx.login</code> 很多人肯定都很陌生。这里将他们放在前面说，是因为后面获取 openid 和 unionid 都会用到这两个方法。</p>\n<p>在讲解这两个方法之前，我先讲一下 sessionKey 吧。仔细看过微信开发文档的人，肯定都见过 sessionKey 这个字眼。微信在解密加密数据的时候，都需要这个值才能解密成功。通过 jssdk 或者其他方法拿到 code 之后，再向服务端请求换取 sessionKey。sessionKey 不推荐保存在客户端，所以换取的过程应该坐在服务端，客户端通过请求服务端接口拿到换取后的信息（openid 和 unionid）。</p>\n<p>调用 <code class=\"language-text\">wx.login</code> 时，会得到一个 code，有了 code，我们(服务端)就可以请求 <code class=\"language-text\">https://api.weixin.qq.com/sns/jscode2session?appid=APP_ID&amp;secret=APP_SECRET&amp;js_code=CODE&amp;grant_type=authorization_code</code>。之后你就可以在返回结果中，拿到 sessionKey, openid 和 unionid。<code class=\"language-text\">APP_ID</code> 和 <code class=\"language-text\">APP_SECRET</code> 分别是小程序的 appid 和 secret，你都可以在小程序的后台看到。<code class=\"language-text\">CODE</code> 就是通过 <code class=\"language-text\">wx.login</code> 得到的。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">wx<span class=\"token punctuation\">.</span><span class=\"token function\">login</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">success</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> code<span class=\"token punctuation\">,</span> errMsg <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 发起网络请求</span>\n      wx<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 请求你自己的服务器，该接口背后调用了 https://api.weixin.qq.com/sns/jscode2session?appid=&lt;APP_ID>&amp;secret=&lt;APP_SECRET>&amp;js_code=&lt;CODE>&amp;grant_type=authorization_code</span>\n        url<span class=\"token operator\">:</span> <span class=\"token string\">'https://test.server.com/wechat/minprogram/login'</span><span class=\"token punctuation\">,</span>\n        data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> code <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'获取用户登录态失败！'</span> <span class=\"token operator\">+</span> errMsg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>虽然拿到 code 之后换取 sessionKey 时，返回的有 openid 和 unionid。但是 unionid 字段可能为空。这和微信的 <a href=\"https://mp.weixin.qq.com/debug/wxadoc/dev/api/uinionID.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">unionid 机制</a>有关。如果一个用户未使用过你注册的任何业务（第三方登录，服务号等）。那么在这一步你是拿不到 unionid 的。下面就得 <code class=\"language-text\">wx.getUserInfo</code> 大显身手了。</p>\n<p>在 <code class=\"language-text\">wx.getUserInfo</code> <a href=\"https://mp.weixin.qq.com/debug/wxadoc/dev/api/open.html#wxgetuserinfoobject\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">文档的第一行</a>你就能看到一句话（他很重要）。<strong>获取用户信息，withCredentials 为 true 时需要先调用 <code class=\"language-text\">wx.login</code> 接口。</strong>。只有你传入了 withCredentials 为 true，在返回值中才会有，encryptedData 和 iv 字段。解密这两个字段你就能拿到 openid 和 unionid。（这个地方必有 unionid）。解密过程也做在服务端即可。</p>\n<p><em>解密时需要 sessionKey，因此 sessionKey 需要服务端自行保存和维护起来。推荐放入 redis 里。每次调用 <code class=\"language-text\">wx.login</code> 时刷新 sessionKey。</em></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">wx<span class=\"token punctuation\">.</span><span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 确保调用该方法之前，调用了 wx.login</span>\n  <span class=\"token comment\">// 只有该参数为 true，返回值中才会有 encryptedData 和 iv</span>\n  withCredentials<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">success</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> userInfo<span class=\"token punctuation\">,</span> encryptedData<span class=\"token punctuation\">,</span> iv <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">dir</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    wx<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      url<span class=\"token operator\">:</span> <span class=\"token string\">'https://test.server.com/wechat/minprogram/decipher'</span><span class=\"token punctuation\">,</span>\n      data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        encryptedData<span class=\"token punctuation\">,</span>\n        iv<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h4 id=\"登录态维护\" style=\"position:relative;\"><a href=\"#%E7%99%BB%E5%BD%95%E6%80%81%E7%BB%B4%E6%8A%A4\" aria-label=\"登录态维护 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>登录态维护</h4>\n<p>每次调用 <code class=\"language-text\">wx.login</code> 都会刷新登录态。登录态刷新会导致 sessionKey 的失效。因此我们需要维护登录态。使用 <code class=\"language-text\">wx.checkSession</code> 可以检查登录态是否失效。如果失效需要我们自行的重新调用 <code class=\"language-text\">wx.login</code>。</p>\n<p><strong>开发者要注意不应该直接把 session_key、openid 等字段作为用户的标识或者 session 的标识，而应该自己派发一个 session 登录态（请参考登录时序图）。对于开发者自己生成的 session，应该保证其安全性且不应该设置较长的过期时间。session 派发到小程序客户端之后，可将其存储在 storage ，用于后续通信使用。</strong></p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 703px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 121.19487908961592%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsSAAALEgHS3X78AAACqklEQVQ4y41Va08qMRTk//8n4xejJkajogkBwYs85LnLc9ln586ULVm45UKTurhtp3NmzjlbG4/HGAwG2Gw2cMMYY6fGZDJBu91Gp9NBlmVH627PYrFAo9FAr9dDbbvdIggCLJdLJElyOORGmqZYr9d2OoDqxW6PQKMoQk0v5/M5xFRs+v2+/V8bdEFRFPbpRsbDG4LvdjsYrqEEdeA1HRBL3aKD+i22mjqkd/odxTG2ZPA7GqH59YUuwwt4acxzMfeIgLAsYJ7n+N8Q8GI6RbxaIeQz+P3F7OcH4XCIXRgikiRcE0sL6BO7KrpYZJ+fwMsL8P6+f3KahweYx0cYss3I3riQq4DnRI8YUsZMKHSQ4fMlb4r3U2Zyehn6AKXRiEZNGd6SgE4gU05rFmU7ADoNzwHulBI0ArMZQO3w/Q2jJ/PXUEeKjExp5Uy5GDJdzm9vgddXGCa4kZ5MdtNqwTSbAA3JuOdqwIS3p3d3gAygKTICz88AWVvAbhcZc/h6U8Tg5ga4v4d5e7MMzccHwBQynNTMGuZl6EubhJszVhJU79orzemukeMshIOG17qccn1OY0LqtOBUXReu5E5d1h+BVkHycvFQvwScUqM/dLdFI9R9XH27fdpzYKhajUW7LHw1CZVSzLBcLau9uRRzBKqyHAEqjAlbWEiQJQ+uqEsu5txYVMLxyfEvIP+s2EEiJmrCZ8rkTWiAYVUovzRzXeBh5WWoGkmoDZ6eQIFsFaBe3yexEpidJWcExQmjU6ZHDLdksVZ5MVy1okT1qqJXepBZwc22PD1p5dUwYHhqkAPWZYcM9W0Y05gNQ5V+au3nhhdQDVQv5Ko6tgDkalR2cuf8ipFoTVO5WL3oCPBSx9bmOnXVl09fyCEjURT6uDmWR4AXO3aZj9eE/BdEcUzlgcAOlAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"微信官方 登录时序图\"\n        title=\"微信官方 登录时序图\"\n        src=\"/static/2ee3d897beb30b4521439cc68a82dba3/aee27/login-1.png\"\n        srcset=\"/static/2ee3d897beb30b4521439cc68a82dba3/8c2ab/login-1.png 300w,\n/static/2ee3d897beb30b4521439cc68a82dba3/3f01f/login-1.png 600w,\n/static/2ee3d897beb30b4521439cc68a82dba3/aee27/login-1.png 703w\"\n        sizes=\"(max-width: 703px) 100vw, 703px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">微信官方 登录时序图</figcaption>\n  </figure></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">wx<span class=\"token punctuation\">.</span><span class=\"token function\">checkSession</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">success</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 未过期</span>\n    <span class=\"token comment\">// TODO: 检查第三方session 是否过期</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">check3rdSession</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 未过期</span>\n      <span class=\"token comment\">// TODO: storage 中获取已有第三方登录数据</span>\n      <span class=\"token function\">getAppInfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 过期，重新登录</span>\n    <span class=\"token function\">wechatLogin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">fail</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 已过期</span>\n    <span class=\"token function\">wechatLogin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"mixin\" style=\"position:relative;\"><a href=\"#mixin\" aria-label=\"mixin permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>mixin</h3>\n<p>微信自定义组件中，有一个特性叫做 <strong><a href=\"https://mp.weixin.qq.com/debug/wxadoc/dev/framework/custom-component/behaviors.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">behavior</a></strong>。它是用于组件间代码共享的特性，类似于一些编程语言中的 “mixins” 或 “traits”。</p>\n<p>然而 <a href=\"https://mp.weixin.qq.com/debug/wxadoc/dev/framework/app-service/page.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Page</a> 没有这种类似的特性。而这种特性很常用，比方说统一的页面加载逻辑，就会需要共享一部分 data 结构，和一部分方法。</p>\n<p>因此我们自己实现了一个简单的 mixin。这里我就不去讲解代码的含义了，代码十分的简单。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * 将多个对象中的方法整合为一个\n * @param methodName\n * @param list\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">combinePageMethods</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">methodName<span class=\"token punctuation\">,</span> list <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">combinedPageMethod</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    list<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">item<span class=\"token punctuation\">,</span> index</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">[</span>methodName<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>list<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span> <span class=\"token operator\">!==</span> index<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>\n            <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">mixin: \\`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>item<span class=\"token punctuation\">.</span>$name<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\\`'s </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>methodName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> lifecycle method will be called</span><span class=\"token template-punctuation string\">`</span></span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        item<span class=\"token punctuation\">[</span>methodName<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/**\n * Page 支持 mixin\n *\n * @param page\n */</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">PageMixins</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">page</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> mixins<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>nativePage <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> page<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 如果没有 mixiin</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mixins <span class=\"token operator\">||</span> mixins<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> nativePage<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> pagesDataList <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>mixins<span class=\"token punctuation\">,</span> nativePage<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> pageDataWithMixin <span class=\"token operator\">=</span> pagesDataList<span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">page<span class=\"token punctuation\">,</span> mixin</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data<span class=\"token operator\">:</span> pageData <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>pageMethods <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> page<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> $name<span class=\"token punctuation\">,</span> data<span class=\"token operator\">:</span> mixinData <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>mixinMethods <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> mixin<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>pageData<span class=\"token punctuation\">,</span>\n        <span class=\"token operator\">...</span>mixinData<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token operator\">...</span>pageMethods<span class=\"token punctuation\">,</span>\n      <span class=\"token operator\">...</span>mixinMethods<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>pageDataWithMixin<span class=\"token punctuation\">,</span>\n    onLoad<span class=\"token operator\">:</span> <span class=\"token function\">combinePageMethods</span><span class=\"token punctuation\">(</span><span class=\"token string\">'onLoad'</span><span class=\"token punctuation\">,</span> pagesDataList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    onReady<span class=\"token operator\">:</span> <span class=\"token function\">combinePageMethods</span><span class=\"token punctuation\">(</span><span class=\"token string\">'onReady'</span><span class=\"token punctuation\">,</span> pagesDataList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    onShow<span class=\"token operator\">:</span> <span class=\"token function\">combinePageMethods</span><span class=\"token punctuation\">(</span><span class=\"token string\">'onShow'</span><span class=\"token punctuation\">,</span> pagesDataList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    onHide<span class=\"token operator\">:</span> <span class=\"token function\">combinePageMethods</span><span class=\"token punctuation\">(</span><span class=\"token string\">'onHide'</span><span class=\"token punctuation\">,</span> pagesDataList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    onUnload<span class=\"token operator\">:</span> <span class=\"token function\">combinePageMethods</span><span class=\"token punctuation\">(</span><span class=\"token string\">'onUnload'</span><span class=\"token punctuation\">,</span> pagesDataList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    onPullDownRefresh<span class=\"token operator\">:</span> <span class=\"token function\">combinePageMethods</span><span class=\"token punctuation\">(</span><span class=\"token string\">'onPullDownRefresh'</span><span class=\"token punctuation\">,</span> pagesDataList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    onReachBottom<span class=\"token operator\">:</span> <span class=\"token function\">combinePageMethods</span><span class=\"token punctuation\">(</span><span class=\"token string\">'onReachBottom'</span><span class=\"token punctuation\">,</span> pagesDataList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    onPageScroll<span class=\"token operator\">:</span> <span class=\"token function\">combinePageMethods</span><span class=\"token punctuation\">(</span><span class=\"token string\">'onPageScroll'</span><span class=\"token punctuation\">,</span> pagesDataList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// 新增方法</span>\n    onTabItemTap<span class=\"token operator\">:</span> <span class=\"token function\">combinePageMethods</span><span class=\"token punctuation\">(</span><span class=\"token string\">'combinePageMethods'</span><span class=\"token punctuation\">,</span> pagesDataList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>因此我们使用起来就变得很简单了。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/* mixins/customMixin.js */</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">{</span>\n  data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    mixinData<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">mixinMethods</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* index.js */</span>\n<span class=\"token keyword\">import</span> Mixin <span class=\"token keyword\">from</span> <span class=\"token string\">'utils/mixin'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> customMixin <span class=\"token keyword\">from</span> <span class=\"token string\">'mixins/customMixin'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">Page</span><span class=\"token punctuation\">(</span>\n  <span class=\"token function\">Mixin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      myData<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    mixins<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>customMixin<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">someMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 访问数据</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">dir</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>mixinData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 更新数据</span>\n        <span class=\"token string\">'mixinData[0]'</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// 调用 mixin 中方法</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">mixinMethods</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong><em>注意：写 mixin 时，方法不要使用 <code class=\"language-text\">=&gt;</code> 书写方式，会导致 <code class=\"language-text\">this</code> 不正确。<a href=\"https://segmentfault.com/a/1190000003781467#articleHeader2\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">你可以参考</a></em></strong></p>\n<h3 id=\"page-loading\" style=\"position:relative;\"><a href=\"#page-loading\" aria-label=\"page loading permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>page-loading</h3>\n<p>搞过 iOS 或 Android 开发，在开发具体功能之前，肯定都需要封装一个组件（Android 叫 Activity，iOS 叫 ViewController 应该是这样），其需要封装一些功能：上拉刷新，下拉加载，滑到底部的样式，加载中的样式，网络错误样式，页面为空样式等等。然后我们复用这个组件就可以了。这里 page-loading 组件就是这么一个存在。</p>\n<p>page-loading 是一个自定义组件，也会暴露一个 mixin。该 mixin 中会暴露一些 data 和 公众方法。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// mixins/pageLoadingMixin.js</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">{</span>\n  data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 请求状态</span>\n    $pageLoadingStatus<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// 请求数据</span>\n    $pageLoadingData<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token comment\">// 配置属性</span>\n  $pageLoadingConf<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token comment\">// page-loading 状态信息</span>\n  $pageLoadingState<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token comment\">// 数据缓存</span>\n  $pageLoadingStore<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token comment\">// 暴露方法</span>\n  <span class=\"token function\">$pageLoadingInit</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">config <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$pageLoadingConf <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span>this<span class=\"token punctuation\">.</span>$pageLoadingConf<span class=\"token punctuation\">,</span>\n      <span class=\"token operator\">...</span>config<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token comment\">// 数据请求接口</span>\n  <span class=\"token function\">$pageLoadingFetch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token comment\">// 上拉刷新</span>\n  <span class=\"token function\">onPullDownRefresh</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token comment\">// 下拉加载</span>\n  <span class=\"token function\">onReachBottom</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>在 page-loading 组件中，我们传入 <code class=\"language-text\">$pageLoadingStatus</code> 即可。 有了 mixin 是不是觉得很简单？</p>\n<h3 id=\"网络检测\" style=\"position:relative;\"><a href=\"#%E7%BD%91%E7%BB%9C%E6%A3%80%E6%B5%8B\" aria-label=\"网络检测 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>网络检测</h3>\n<p>因为我们有直播，所以需要用到网络检测。微信提供两个方法：一个是 <code class=\"language-text\">wx.getNetworkType</code>，另一个是 <code class=\"language-text\">wx.onNetworkStatusChange</code>。看似很美好对么？然而在使用中，我发现，这个 <code class=\"language-text\">wx.onNetworkStatusChange</code> 会在全局加一个网络监听事件。即使退出直播，你还会收到网络变化的回调。额 O__O \"…，这可不好。</p>\n<p>这时候又是 mixin 大显身手的时候了，我们自己实现了一个简单的网络检测方法。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// mixins/networkMixin.js</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">NETWORK_STATUS</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token constant\">WIFI</span><span class=\"token operator\">:</span> <span class=\"token string\">'wifi'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'4G'</span><span class=\"token operator\">:</span> <span class=\"token string\">'4g'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'3G'</span><span class=\"token operator\">:</span> <span class=\"token string\">'3g'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'2G'</span><span class=\"token operator\">:</span> <span class=\"token string\">'2g'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">UNKNOWN</span><span class=\"token operator\">:</span> <span class=\"token string\">'unknown'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">NONE</span><span class=\"token operator\">:</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * 网络检测定时器\n */</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">{</span>\n  $name<span class=\"token operator\">:</span> <span class=\"token string\">'NetworkMixin'</span><span class=\"token punctuation\">,</span>\n\n  data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    $network<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NONE</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WIFI</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'2G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'3G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'4G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UNKNOWN</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  $latestNetworkStatus<span class=\"token operator\">:</span> <span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WIFI</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 回调列表</span>\n  $networkCbs<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 网络检测定时器</span>\n  $networkTimer<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token function\">onUnload</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 移除网络监听</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">$offNetworkStatusChange</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token function\">$onNetworkStatusChange</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">cb</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cb<span class=\"token punctuation\">)</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$networkCbs<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>cb<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$networkTimer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 启动定时器</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$networkTimer <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_networkStepInterval<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token function\">$offNetworkStatusChange</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">cb</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cb<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$networkCbs <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$networkCbs<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ncb</span> <span class=\"token operator\">=></span> ncb <span class=\"token operator\">!==</span> cb<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$networkCbs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$networkCbs<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 关闭定时器</span>\n      <span class=\"token function\">clearInterval</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$networkTimer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$networkTimer <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token function\">_networkStepInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> $<span class=\"token keyword\">this</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n\n    wx<span class=\"token punctuation\">.</span><span class=\"token function\">getNetworkType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token function-variable function\">success</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> networkType <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 事件回调</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> len <span class=\"token operator\">=</span> $<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$networkCbs<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> len<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> cb <span class=\"token operator\">=</span> $<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$networkCbs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n          result <span class=\"token operator\">=</span> <span class=\"token function\">cb</span><span class=\"token punctuation\">(</span>networkType<span class=\"token punctuation\">,</span> $<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$latestNetworkStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// 网络变化</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>$<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$latestNetworkStatus <span class=\"token operator\">!==</span> networkType<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>networkType <span class=\"token operator\">===</span> <span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WIFI</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n              $network<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NONE</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WIFI</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'2G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'3G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'4G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UNKNOWN</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>networkType <span class=\"token operator\">===</span> <span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'4G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n              $network<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NONE</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WIFI</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'2G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'3G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'4G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UNKNOWN</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>networkType <span class=\"token operator\">===</span> <span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'3G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n              $network<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NONE</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WIFI</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'2G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'3G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'4G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UNKNOWN</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>networkType <span class=\"token operator\">===</span> <span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'2G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n              $network<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NONE</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WIFI</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'2G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'3G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'4G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UNKNOWN</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>networkType <span class=\"token operator\">===</span> <span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UNKNOWN</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n              $network<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NONE</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WIFI</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'2G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'3G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'4G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UNKNOWN</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>networkType <span class=\"token operator\">===</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n              $network<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NONE</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WIFI</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'2G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'3G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">[</span><span class=\"token string\">'4G'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">[</span><span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UNKNOWN</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">!==</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          $<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$latestNetworkStatus <span class=\"token operator\">=</span> networkType<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>使用起来很简单：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// index.js</span>\n<span class=\"token keyword\">import</span> Mixin <span class=\"token keyword\">from</span> <span class=\"token string\">'utils/mixin'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> networkMixin<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">NETWORK_STATUS</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'mixins/networkMixin'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">Page</span><span class=\"token punctuation\">(</span>\n  <span class=\"token function\">Mixin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    mixins<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>networkMixin<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">onLoad</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 开始进行网络检测</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">$onNetworkStatusChange</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_networkChangeHandler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// 网络变化处理</span>\n    <span class=\"token function\">_networkChangeHandler</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">currentNetworkType<span class=\"token punctuation\">,</span> lastNetworkType</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n        currentNetworkType <span class=\"token operator\">!==</span> <span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WIFI</span> <span class=\"token operator\">&amp;&amp;</span>\n        lastNetworkType <span class=\"token operator\">===</span> <span class=\"token constant\">NETWORK_STATUS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WIFI</span>\n      <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 网络波动，给出警告</span>\n        wx<span class=\"token punctuation\">.</span><span class=\"token function\">showModal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n          content<span class=\"token operator\">:</span> <span class=\"token string\">'当前为非 wifi 状态，您是否要继续播放？'</span><span class=\"token punctuation\">,</span>\n          showCancel<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n          <span class=\"token function-variable function\">success</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> confirm <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>confirm <span class=\"token operator\">!==</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              wx<span class=\"token punctuation\">.</span><span class=\"token function\">navigateBack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"im\" style=\"position:relative;\"><a href=\"#im\" aria-label=\"im permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>IM</h3>\n<p>我们使用的是<strong>腾讯 IM</strong>，如果你用的不是腾讯 IM，可以<a href=\"#%E7%9B%B4%E6%92%AD\">绕过这一节</a>。</p>\n<p>腾讯有两种账号登录集成方式：<strong>独立模式</strong>和<strong>托管模式</strong>。具体区别请参考<a href=\"https://cloud.tencent.com/document/product/268/7653\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">官方文档</a>。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 1200px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.99118511263467%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAApklEQVQY06VQXQvDIAz0//9DXzqEPklpmcOvRr0ZXcFu3cNY4IhekoueWJYFxjxQSvkbOyWIuzGwziHljNxQkGuR7x9IGZTSBd85rgnrPXyITZ0zwzqPuBMiUc8vhLjD+XDiGD72OaoLRa6qVAc5tNZQSuE2TWAr+MW/BPGXrbXVQ9M8YEEpJeZ5xrquX7064p1rguMGV73ctg28hM9H4zh0JT4KPgH1FNfI7/BtswAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"im 配置\"\n        title=\"im 配置\"\n        src=\"/static/fa29a920d0fc088b0654f90b8115ed11/f0628/im-1.png\"\n        srcset=\"/static/fa29a920d0fc088b0654f90b8115ed11/8c2ab/im-1.png 300w,\n/static/fa29a920d0fc088b0654f90b8115ed11/3f01f/im-1.png 600w,\n/static/fa29a920d0fc088b0654f90b8115ed11/f0628/im-1.png 1200w,\n/static/fa29a920d0fc088b0654f90b8115ed11/57025/im-1.png 1800w,\n/static/fa29a920d0fc088b0654f90b8115ed11/67e1d/im-1.png 2042w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">im 配置</figcaption>\n  </figure></p>\n<p>使用前，你需要进行一些配置，从而可以连接到腾讯 IM 服务器。如果你是托管模式，除了需要导入 <code class=\"language-text\">webim.js</code> 文件外，还需要导入一个 <code class=\"language-text\">tls.js</code> 文件（<a href=\"https://cloud.tencent.com/product/im\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">选择 IM Web 平台 SDK</a>）。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// mixin/timMixin.js</span>\n<span class=\"token keyword\">import</span> webim <span class=\"token keyword\">from</span> <span class=\"token string\">'vendors/webim'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">{</span>\n  data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    $tim<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 消息列表</span>\n      msg<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">// 当前人数</span>\n      num<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token comment\">// 配置</span>\n  $timConf<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 最大消息队列数目</span>\n    maxMsgSeq<span class=\"token operator\">:</span> <span class=\"token number\">300</span><span class=\"token punctuation\">,</span>\n    sdkAppID<span class=\"token operator\">:</span> <span class=\"token string\">'&lt;APP_ID>'</span><span class=\"token punctuation\">,</span>\n    accountType<span class=\"token operator\">:</span> <span class=\"token string\">'&lt;ACCOUNT_TYPE>'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// 重试次数</span>\n    relogin<span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token function\">onUnload</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">$timLogout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token function\">$timInit</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">conf</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//...</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token comment\">/**\n   * @params times 重试次数\n   */</span>\n  <span class=\"token function\">$timLogin</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">times<span class=\"token punctuation\">,</span> cb<span class=\"token punctuation\">,</span> errCb</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> relogin <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> times <span class=\"token operator\">===</span> <span class=\"token string\">'number'</span> <span class=\"token operator\">?</span> times <span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$timConf<span class=\"token punctuation\">.</span>relogin<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>times <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// im 尝试登陆失败</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>errCb<span class=\"token punctuation\">)</span> <span class=\"token function\">errCb</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>options<span class=\"token punctuation\">.</span>userId <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>options<span class=\"token punctuation\">.</span>access_token <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>options<span class=\"token punctuation\">.</span>groupId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'请传入 userId, access_token 和 groupId'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    webim<span class=\"token punctuation\">.</span><span class=\"token function\">login</span><span class=\"token punctuation\">(</span>\n      <span class=\"token punctuation\">{</span>\n        sdkAppID<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$timConf<span class=\"token punctuation\">.</span>sdkAppID<span class=\"token punctuation\">,</span>\n        appIdAt3rd<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$timConf<span class=\"token punctuation\">.</span>sdkAppID<span class=\"token punctuation\">,</span>\n        accountType<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$timConf<span class=\"token punctuation\">.</span>accountType<span class=\"token punctuation\">,</span>\n        identifier<span class=\"token operator\">:</span> <span class=\"token string\">'&lt;userId>'</span><span class=\"token punctuation\">,</span>\n        identifierNick<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n        <span class=\"token comment\">// 登录 im 服务的凭证</span>\n        userSig<span class=\"token operator\">:</span> <span class=\"token string\">'&lt;sig>'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">onConnNotify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">/* empty */</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token comment\">// 消息通知，处理消息，将结果加入 this.data.$tim.msg</span>\n        <span class=\"token function-variable function\">onMsgNotify</span><span class=\"token operator\">:</span> <span class=\"token parameter\">msgList</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">/* empty */</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token comment\">// 消息通知，处理消息，将结果加入 this.data.$tim.msg</span>\n        <span class=\"token function-variable function\">onBigGroupMsgNotify</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">/* empty */</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function-variable function\">onGroupInfoChangeNotify</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">/* empty */</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        onGroupSystemNotifys<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">/* empty */</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function\">onC2cEventNotifys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">/* empty */</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function\">onFriendSystemNotifys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">/* empty */</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function\">onProfileSystemNotifys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">/* empty */</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function\">onKickedEventCall</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">/* empty */</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function\">onAppliedDownloadUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">/* empty */</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 加入群聊</span>\n        webim<span class=\"token punctuation\">.</span><span class=\"token function\">applyJoinBigGroup</span><span class=\"token punctuation\">(</span><span class=\"token comment\">/* ... */</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">$timLogin</span><span class=\"token punctuation\">(</span>relogin <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> cb<span class=\"token punctuation\">,</span> errCb<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token comment\">// 退出</span>\n  <span class=\"token function\">$timLogout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    webim<span class=\"token punctuation\">.</span><span class=\"token function\">logout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>mixin 大致结构如上。你只需要处理 <code class=\"language-text\">onMsgNotify</code> 和 <code class=\"language-text\">onBigGroupMsgNotify</code> 收到的消息，将消息转化为展示需要的数据结构形式即可。之后你在页面中使用 <code class=\"language-text\">$tim.msg</code> 渲染出消息即可。</p>\n<h3 id=\"直播\" style=\"position:relative;\"><a href=\"#%E7%9B%B4%E6%92%AD\" aria-label=\"直播 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>直播</h3>\n<p>直播有两个组件，一个是 <code class=\"language-text\">&lt;video&gt;</code> 组件，一个是 <code class=\"language-text\">&lt;live-player&gt;</code> 组件。<code class=\"language-text\">&lt;video&gt;</code> 只支持 HLS。<code class=\"language-text\">&lt;live-player&gt;</code> 支持 HLS 和 RTMP 甚至 RTC。但是 <code class=\"language-text\">&lt;live-player&gt;</code> 暂时只对部分类目开放，<a href=\"https://mp.weixin.qq.com/debug/wxadoc/dev/component/live-player.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">官方文档</a></p>\n<p>HLS 延迟高，RTMP 延迟低。我们的场景对延迟要求苛刻，所以最终用的 <code class=\"language-text\">&lt;live-player&gt;</code>。该组件，需要手动开通权限。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 1200px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.96486229819563%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA4klEQVQY03WR0W7DIAxF8/9f2Ic+r5qahhAwwcZwZ0hTVdsqccAKB9uB6ev2DRZF5vIHkfprT/713pnmhwOljBATIu0Dv8Wx3pcFbttAdOzvWT6SMo916lPPnHZ+QT1xSpi9Q6A0CvbvUo6OzzOdHjMrVHAkDCHgPs/YrJNaG7TWARqwiMM1XkccYsRs3rquaM08fXo2Qgm4hAu0NExEEd5veCwrhNmqMXLOqKoozTpXQrNDRATnHFbvjTA8EUEpBdoUqdIoMrHIuOzerog9RNEDi4v9Yq/KFg/4dPnpnJ6+vB9dUdOso9F83QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"im 配置\"\n        title=\"im 配置\"\n        src=\"/static/ddab75f5a7de39aa566bbb8619b9630d/f0628/live-1.png\"\n        srcset=\"/static/ddab75f5a7de39aa566bbb8619b9630d/8c2ab/live-1.png 300w,\n/static/ddab75f5a7de39aa566bbb8619b9630d/3f01f/live-1.png 600w,\n/static/ddab75f5a7de39aa566bbb8619b9630d/f0628/live-1.png 1200w,\n/static/ddab75f5a7de39aa566bbb8619b9630d/57025/live-1.png 1800w,\n/static/ddab75f5a7de39aa566bbb8619b9630d/fe026/live-1.png 2106w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">im 配置</figcaption>\n  </figure></p>\n<p>在开发中遇到了一些问题：</p>\n<ol>\n<li><code class=\"language-text\">&lt;live-player&gt;</code> 组件没有自带控制器，所以，你需要自己实现控制器。</li>\n<li>在 <code class=\"language-text\">&lt;video&gt;</code> 和 <code class=\"language-text\">&lt;live-player&gt;</code> 组件上添加样式，很多样式其实是不支持的。动态展示会出意想不到的问题。<a href=\"https://developers.weixin.qq.com/blogdetail?action=get_post_info&#x26;docid=00068e1b1b453079d916809445b400\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">issue 详情</a></li>\n</ol>\n<h3 id=\"分包\" style=\"position:relative;\"><a href=\"#%E5%88%86%E5%8C%85\" aria-label=\"分包 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>分包</h3>\n<p>我们在开发期间，收到了小程序更新通知。支持了<a href=\"https://mp.weixin.qq.com/debug/wxadoc/dev/framework/subpackages.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">分包加载</a>，我去这个很强大。</p>\n<p>分包加载是 <code class=\"language-text\">v1.7.3</code> 之后支持的。之前会默认项原来那样。所以，你不需要考虑兼容问题。</p>\n<p>目前小程序分包大小有以下限制：</p>\n<ul>\n<li>整个小程序所有分包大小不超过 4M</li>\n<li>单个分包/主包大小不能超过 2M</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"pages\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token comment\">// 全局页面</span>\n    <span class=\"token string\">\"pages/index\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"pages/user\"</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"subPackages\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"root\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"packages/live\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"pages\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token comment\">// 目录 packages/live 下所有 page</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"root\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"packages/course\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"pages\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token comment\">// 目录 packages/course 下所有 page</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"其他\" style=\"position:relative;\"><a href=\"#%E5%85%B6%E4%BB%96\" aria-label=\"其他 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>其他</h3>\n<h4 id=\"setdata\" style=\"position:relative;\"><a href=\"#setdata\" aria-label=\"setdata permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>setData</h4>\n<p><code class=\"language-text\">setData</code> 不要平凡调用和调用时传入过多数据，这两种情况都会导致页面性能的降低。</p>\n<h4 id=\"onpagescroll\" style=\"position:relative;\"><a href=\"#onpagescroll\" aria-label=\"onpagescroll permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>onPageScroll</h4>\n<p>为何要写这个？在我们开发课程详情页的时候，向下滚动会导致页面十分的卡。由于 onPageScroll 频繁调用，造成频繁的 <code class=\"language-text\">wx.createSelectorQuery()</code> 和 <code class=\"language-text\">setData</code> 性能十分低下。所以，我们对 onPageScroll 进行了节流，和对 <code class=\"language-text\">wx.createSelectorQuery()</code> 的结果进行了缓存。</p>\n<h4 id=\"wxcreateselectorquery\" style=\"position:relative;\"><a href=\"#wxcreateselectorquery\" aria-label=\"wxcreateselectorquery permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>wx.createSelectorQuery</h4>\n<p><code class=\"language-text\">wx.createSelectorQuery</code>很强大，具体用法可以查看<a href=\"https://mp.weixin.qq.com/debug/wxadoc/dev/api/wxml-nodes-info.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">官方文档</a>。在复杂页面，比如有定位的页面，可能都会用到 <code class=\"language-text\">wx.createSelectorQuery</code> 来计算展示的样式。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token function\">Page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token function\">onPageScroll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> query <span class=\"token operator\">=</span> wx<span class=\"token punctuation\">.</span><span class=\"token function\">createSelectorQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">in</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    query\n      <span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#id'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">boundingClientRect</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">rect</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">,</span> top<span class=\"token punctuation\">,</span> left<span class=\"token punctuation\">,</span> right<span class=\"token punctuation\">,</span> bottom <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> rect<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 单位 px</span>\n\n        <span class=\"token comment\">// width, height 是 width + padding, height + padding 不包括 margin</span>\n        <span class=\"token comment\">// top 距离顶部值</span>\n        <span class=\"token comment\">// left 距离左侧边框值</span>\n        <span class=\"token comment\">// right 距离右侧边框值</span>\n        <span class=\"token comment\">// bottom 距离底部边框值</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">exec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 776px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 112.37113402061856%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAABYlAAAWJQFJUiTwAAAFJElEQVQ4y21UaWyUZRD+fvsLTURKKZZDlFItpa22XOUmFRSJYKEmQjUkRv1lYgQRSWrAoGKUGEEs0hZBbICWll3OtilCd0uvPbvbvY/u7rdn9z7bfZz3W9hE4ySz78w3zzffzDPzLndk705UrajGxpVrsGXtemxcVYvyklewsPB5FBcUYd6zBaggf9WKKhTNLkTxnCIhtqiwGPPJL3upFJtX16JuyzYcbNgF7rOG3Xhq9kIUFi/F7KIleG7+iyhcuEzQpWXV2LKzAe/UvY6GujrUv/8RyqvXoYCw8xaVomrlBiwuKUdlzTqUVNXigx3bwf3UuBtbS5Zgz2srsLtqOXZVlmFneSneWr4Mb1e8gvfWVqNx3SrsX78ajaT1hNtRViJg6l8tJ8zL2F9bg/qaShx/dwe4c4c/hVKphl6tgnxkGBqlEgGPG1NeDwJuHl6PF16dGt7BPnjcHvh4F6Yo7qcYU4YNEtZiseG3owfB/dn0ObrbWtDbfhHitnNo++FbiNp+x6CoEwNd1yARXYfkykVIWk9DKu7CoPg6pDc6MHSrm85OSLo7BGzPlcu40HQInMduhlk+Ap/VgNNNX2AWx6Hxze2Y1ChgUY6RymCi06pVQzskwUh/D51S9Fy/ivHBhzArRmFVyUll4C16cG4qmae2IvEE7t25i201FZDf60YonoLXH4Db60MwGkUoEoFMoURvfz9MFivEt27jbk8PukQiWGw2OHk3WC6Odzngcjrg9brRcv48GjatwZnDn+DutTbYJycRmAqgT3wDZ49/DYNuAiMjI9DrdFCrlGQPoa+vFyqyjUYDPB4XOJdzErFYFM2/nkHRnDlYtGAxKktLsHf1C2j++RQ62tvReuY0JPf7wdMQXC6noDL5GB4MPERLayvkchmsVgsNjRL6/V50XutAZVkZiubOxYFNxTiweQGWLV6AN2hFhruvIBgOC5U6HJP0opUSOjAiHcDt7i5camuFzWaFk7rkeSe1TD9bN23A3IIC7KtbC1HTPhzZU4Ht62sw6+ln8NXHHyJssxPPHjiIApPZJLzcfq4ZzSe/h6j9L3h9HkrmyiWMU7tGoxFSqRTjCjmcdh4W/TgCTqMwBIPRhOnpaaTTaWQymbz9RLKkQoyex2IRShiPUhs2jI9rodHqkEylEI7GEAhFEafJBwIBRGnK/yfZbBbZmRnMkDJJJRPgEomY4CTo5ccoARANepBORP5VCUvAJJlMIk0f/q8kEnFwqVQCkXAEitFhepAUAgFfEKO9VxHymnK+2waX4W88zgeLTg+H1S7YTqcTrS0XodXoiI40uGQqjXTMj0fiL/NVGtVK/PHdsfyXFaMPYTeN533dnQ7wWlUuudmMb46dwKB0iNqfpgqpb7vdirFH9+Dz+QTQhFaLRwMDCEfCSKWSmJiYgEYzgVAoJJCvom6MtOTMZmLQ66m6GaIhSRUm4wQM0zStNIS4AOBpcRVjQzS9DPGZRTDgh4t2kPlsymwrgsGQwDXjNUB2JjOdGwrjMEZTVcpk9CBHtFYxhrMnDuVbtJktsJnMgp2hFXnQI4bbkeMwRbxf/uUELAYDZrIzLGEK8fAU5Dd/FEoWONSocPnsyXxC+YN+qIelef9CyyXcvCF+/IEMOk8dBW+3YZpxmKQy/cSd5H4vnA6nAAqHQ8KFfyJ64kutyg2B7WRfXz/dX2V+VZSyMbolPLWdzu0h4yYUilAwN2XGU5zsJ3vH7Gg0t6/strAimLI4w7K/NtYpo+8fc2uafHtDoz4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"wx.createSelectorQuery\"\n        title=\"wx.createSelectorQuery\"\n        src=\"/static/45888e7540366c3136436f1a4a11e9e1/969f4/createSelectorQuery-1.png\"\n        srcset=\"/static/45888e7540366c3136436f1a4a11e9e1/8c2ab/createSelectorQuery-1.png 300w,\n/static/45888e7540366c3136436f1a4a11e9e1/3f01f/createSelectorQuery-1.png 600w,\n/static/45888e7540366c3136436f1a4a11e9e1/969f4/createSelectorQuery-1.png 776w\"\n        sizes=\"(max-width: 776px) 100vw, 776px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">wx.createSelectorQuery</figcaption>\n  </figure></p>\n<p>对于上图，banner 的 top 值为 B 区域的高度。最近，微信小程序<a href=\"https://mp.weixin.qq.com/debug/wxadoc/dev/framework/config.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">配置项</a>添加了新参数--navigationStyle。navigationStyle 默认为 default。表示展示 A 区域。当 navigationStyle 值为 custom 时，不会展示 A 区域，其余其余会向上移动。因此此时 banner 的 top 值依旧为 B 区域的高度。</p>\n<h4 id=\"wxfor\" style=\"position:relative;\"><a href=\"#wxfor\" aria-label=\"wxfor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>wx:for</h4>\n<p><a href=\"https://mp.weixin.qq.com/debug/wxadoc/dev/framework/view/wxml/list.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">wx:for</a> 也是性能优化的一个点。所以，使用中需要小心。</p>\n<h2 id=\"尾声\" style=\"position:relative;\"><a href=\"#%E5%B0%BE%E5%A3%B0\" aria-label=\"尾声 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>尾声</h2>\n<p>这篇文章代码比较多，写的比较零散。希望对你开发小程序有所启迪和帮助。</p>\n<p>小程序现如今的开发体验已经比去年初好了很多了。虽然小程序有很多的意想不到的问题。但是正常情况下都十分的完美。最近官方又开放了小游戏功能，跳瓶子我想大家已经都知道了。所以快去成为小程序开发的一员吧！</p>\n<p><em>公司上升期，需要大量志同道合的人才，有兴趣的小伙伴可以加入我们哦~ <a href=\"https://www.lagou.com/gongsi/j51416.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Follow finger, anyone can play</a></em></p>","excerpt":"小程序已经有 1 年多时间了吧！从刚出来我就在关注，当时小程序写个组件，需要使用  这样的形式来复用组件。非常的不直观。从 1.6.…","headings":[{"value":"技术选型","depth":2},{"value":"核心功能","depth":2},{"value":"登录","depth":3},{"value":"openid 和 unionid","depth":4},{"value":"wx.login 和 wx.getUserInfo","depth":4},{"value":"登录态维护","depth":4},{"value":"mixin","depth":3},{"value":"page-loading","depth":3},{"value":"网络检测","depth":3},{"value":"IM","depth":3},{"value":"直播","depth":3},{"value":"分包","depth":3},{"value":"其他","depth":3},{"value":"setData","depth":4},{"value":"onPageScroll","depth":4},{"value":"wx.createSelectorQuery","depth":4},{"value":"wx:for","depth":4},{"value":"尾声","depth":2}],"timeToRead":22,"wordCount":{"paragraphs":70,"sentences":71,"words":542},"frontmatter":{"title":"“Finger 音乐课堂”小程序开发总结","cover":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAMEBf/EABUBAQEAAAAAAAAAAAAAAAAAAAEC/9oADAMBAAIQAxAAAAHmUtnmpBP/xAAbEAACAQUAAAAAAAAAAAAAAAAAAgEDEBExMv/aAAgBAQABBQIZMWjmps//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAYEAACAwAAAAAAAAAAAAAAAAAAEAExgf/aAAgBAQAGPwItSYv/xAAbEAACAwADAAAAAAAAAAAAAAABEQAQMUFhof/aAAgBAQABPyEAkh+RZ65cyoCHun//2gAMAwEAAgADAAAAEPgv/8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQMBAT8QZ//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAECAQE/EBn/xAAbEAEBAQACAwAAAAAAAAAAAAABEQAxQSFRgf/aAAgBAQABPxC5kHxRXXJRwQPXX3JSc4BAOXrEsIgr703/2Q==","aspectRatio":2.4,"src":"/static/286d12a028006c165277cfc50d03877d/b4082/cover.jpg","srcSet":"/static/286d12a028006c165277cfc50d03877d/eebca/cover.jpg 300w,\n/static/286d12a028006c165277cfc50d03877d/6fecb/cover.jpg 600w,\n/static/286d12a028006c165277cfc50d03877d/b4082/cover.jpg 1200w,\n/static/286d12a028006c165277cfc50d03877d/3e6db/cover.jpg 1800w,\n/static/286d12a028006c165277cfc50d03877d/176ac/cover.jpg 1920w","sizes":"(max-width: 1200px) 100vw, 1200px"}}},"date":"Feb 8","author":{"id":"blackcater","nickname":"blackcater","avatar":{"childImageSharp":{"resize":{"src":"/static/3e72cc359750952f52e27f3b2a59a0ff/c0e17/blackcater.png"}}}},"tags":[{"id":"miniprogram","name":"小程序"}],"series":null}}},"pageContext":{"id":"b7056da1-8c2a-5c7c-81ea-0fd3b269adae","prevSlug":"","nextSlug":"/2019/03-01/deploy-your-own-npm-registry"}}}
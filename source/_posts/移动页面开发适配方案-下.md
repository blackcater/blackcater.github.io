---
title: 移动页面开发适配方案(下)
date: 2017-01-22 13:43:52
tags:
  - h5
  - mobile
categories: Original
excerpt: 在现如今，那么多手机，大小各不相同，如何让h5页面在各种手机上展现的几乎一样呢？
cover: http://caiguofeng.com/uploads/allimg/160819/1-160Q9111Q2436.jpg
---

[toc]

**相关文章**

- [移动页面开发适配方案(上)](http://www.blackcater.win/2017/01/21/移动页面开发适配方案-上/)
- [移动页面开发适配方案(下)](http://www.blackcater.win/2017/01/22/移动页面开发适配方案-下/)

[在上一期](http://www.blackcater.win/2017/01/21/移动页面开发适配方案-上/)，我们讲解了一些移动开发基础知识和百分比适配方案。

最后我们引入了当下最好的方式`rem`适配，讲解了一下`rem`适配原理，那么接下来，下篇，我们主要介绍如果实现这个适配库。

下面要讲解的已经封装为一个项目，可以clone [flexible@blackcater](https://github.com/blackcater/flexible) 直接使用。

## JS

这里我们通过上面说的理论，写一段JS，去动态设置`rem`基准值和添加`meta`标签

```javascript

(function () {
	var userAgent = window.navigator.userAgent
	var isIphone = (userAgent.search(/iphone/i) !== -1)
	var dpr = 1
	var scale = 1

	if (isIphone) {
		// iOS下，对于2和3的屏，用2倍的方案，其余的用1倍方案
        if (window.devicePixelRatio >= 3) {                
            dpr = 3
        } else if (window.devicePixelRatio >= 2){
            dpr = 2
        } else {
            dpr = 1
        }
	} else {
		 // 其他设备下，仍旧使用1倍的方案
        dpr = 1
	}

 	scale = 1 / dpr

 	// 添加meta标签
 	var meta$ = document.createElement('meta')

 	meta$.setAttribute('name', 'viewport')
 	meta$.setAttribute('content', 'width=device-width,initial-scale=' + scale + ',maximum-scale=' + scale + ',minimum-scale=' + scale + ',user-scalable=no')

 	document.head.appendChild(meta$)

 	// 设置 dpr 和 font-size
 	var clientWidth = document.documentElement.clientWidth

 	document.documentElement.dataset.dpr = dpr
	document.documentElement.style.fontSize = clientWidth / 10 + 'px'
})()

```

总结一下，上面JS代码主要就做了2件事：

1. 添加`<meta name="viewport" ....>`标签
2. 给html添加`font-size`css属性值和添加`data-dpr`自定义属性

## CSS

在将`px`转化为`rem` 我们自己去口算肯定不可能的，这里推荐使用`scss`或`stylus`，不太推荐大家用`less`。后面会详细说明。

**每个版本都提供2个变量：**

1. `flexible-unit` : `rem`适配基准值, 可以通过 `设备宽度 * dpr / 10`进行计算得出。 默认为`75`(iPhone6)
2. `flexible-dpr` : `dpr`值，默认为`2`(iPhone6)

你可以覆盖这些变量。

**每个都提供3个函数(mixin/function)**

1. `px2rem` : 将`px`值转化为`rem`值，如果值是 `em`单位，则不做处理。
2. `font-dpr` : 在`rem`移动适配中，我们不推荐对字体也转化为`rem`单位，但是字体需要适配高清屏，所以通过这个函数，可以快速生成适配各种`dpr`的`font-size`大小值
3. `px-dpr` : 有时候，不仅仅`font-size`属性，我们不需要转为`rem`，可能`border`属性，之类的我们也不需要转成`rem`形式，但是需要适配高清屏，这时候可以使用这个函数。

### sass/scss

```scss
// basic
$flexible-unit: 75;
$flexible-dpr: 2;

// 将 px 单位 转化为 rem单位值
// $value {px} 没有单位 会当做 px处理，rem不处理
// $width 基础值
@function px2rem($value, $width: $flexible-unit) {
	@if (unit($value) == rem) {
		@return $value;
	}

	@if (unitless($value)) {
		@warn "Assuming #{$px} to be in pixels, attempting to convert it into pixels for you";
        @return px2rem($px + 0px);
	}

	@return ($value / $width) * 1rem;
}

// 对于文字，我们不推荐使用 rem 进行，应该使用px特定大小
// font-size 默认 dpr 2
@mixin font-dpr($font-size, $dpr: $flexible-dpr) {
    @if ($dpr == 1) {
		font-size: $font-size;

	    [data-dpr="2"] & {
	        font-size: $font-size * 2;
	    }

	    [data-dpr="3"] & {
	        font-size: $font-size * 3;
	    }
    } 
    @if ($dpr == 2) {
		font-size: $font-size / 2;

	    [data-dpr="2"] & {
	        font-size: $font-size;
	    }

	    [data-dpr="3"] & {
	        font-size: $font-size * 1.5;
	    }
	} 
	@if ($dpr == 3) {
		font-size: $font-size / 3;

	    [data-dpr="2"] & {
	        font-size: $font-size * 2 / 3;
	    }

	    [data-dpr="3"] & {
	        font-size: $font-size;
	    }
	}
}

// 除了字体，有时候一些属性，我们也不需要使用rem适配
@mixin px-dpr($property, $size, $others: "", $dpr: $flexible-dpr) {
	@if ($dpr == 1) {
		#{$property}: $size #{$others};

	    [data-dpr="2"] & {
	        #{$property}: $size * 2 #{$others};
	    }

	    [data-dpr="3"] & {
	        #{$property}: $size * 3 #{$others};
	    }
	}
	@if ($dpr == 2) {
		#{$property}: $size / 2 #{$others};

	    [data-dpr="2"] & {
	        #{$property}: $size #{$others};
	    }

	    [data-dpr="3"] & {
	        #{$property}: $size * 1.5 #{$others};
	    }
	} 
	@if ($dpr == 3) {
		#{$property}: $size / 3 #{$others};

	    [data-dpr="2"] & {
	        #{$property}: $size * 2 / 3 #{$others};
	    }

	    [data-dpr="3"] & {
	        #{$property}: $size #{$others};
	    }
	}
}
```

### less

由于`less@2`是不支持自定义函数这种功能的，所以实现`px2rem`功能函数使用了hack方式

```less
// less hack function
@flexible-px2rem: `(function() {
	// change this function to the basic value
    function px2rem(x) {
      return x/75;
    }

    var less = process.mainModule.children.find(function (child) {
        return child.exports.lesscHelper;
    }).exports;

    less.functions.functionRegistry.add("px2rem", function(x, y) {
    	if (x.unit == 'em') {
			return new less.tree.Dimension(x.value, 'em')
    	} else {
			return new less.tree.Dimension(px2rem(x.value), 'rem');
    	}
    });
})()`;
```

你之后就可以像使用内建函数一样使用`px2rem`(在`less@2.5`没问题，但是其他版本可能有问题，如果有问题，可以提个`issue`给我，[点这儿提issue](https://github.com/blackcater/flexible/issues))

```less
	.test {
		padding: px2rem(12px);
	}
```

不过可喜的是，`less@3`是支持自定义函数的[mixins-as-functions](https://github.com/less/less-meta/blob/master/proposal/mixins-as-functions.md)

```less
 @flexible-unit : 75;
 
.px2rem(@value; @width: @flexible-unit): @return {
	@return: @value / @width;
}
```

然而，现在`less@3`并不稳定，所以不推荐大家使用。另一中解决方案是 使用 `less`插件[less-plugin-functions](https://github.com/seven-phases-max/less-plugin-functions)

```less
// less 插件 less-plugin-functions 自定义函数
@flexible-unit: 75;

.function {
	.px2rem(@value; @width: @flexible-unit) {
		return: @value;
	}
}
```

### stylus

个人觉得`stylus`是最不错的选择，起码代码写出来比其他几个都整洁(开玩笑，跟人经常用的其实是sass和less)

```stylus
flexible-unit = 75
flexible-dpr = 2

px2rem(value, width = flexible-unit)
	if unit(value) == 'em'
		value
	else
		unit(value / width, 'rem')


font-dpr(size, dpr = flexible-dpr)
	if dpr == 1
		font-size size
		[data-dpr="2"] &
			font-size (size*2)
		[data-dpr="3"] &
			font-size (size*3)
	else if dpr == 2
		font-size (size/2)
		[data-dpr="2"] &
			font-size size
		[data-dpr="3"] &
			font-size (size*1.5)
	else
		font-size (size/3)
		[data-dpr="2"] &
			font-size (size*2/3)
		[data-dpr="3"] &
			font-size size


px-dpr(property, size, rest..., dpr = flexible-dpr)
	if dpr == 1
		{property} size rest
		[data-dpr="2"] &
			{property} (size*2) rest
		[data-dpr="3"] &
			{property} (size*3) rest
	else if dpr == 2
		{property} (size/2) rest
		[data-dpr="2"] &
			{property} size rest
		[data-dpr="3"] &
			{property} (size*1.5) rest
	else
		{property} (size/3) rest
		[data-dpr="2"] &
			{property} (size*2/3) rest
		[data-dpr="3"] &
			{property} size rest


```

## 总结

通过两篇文章，总于完成了这个系列，真心累啊！先哭会/(ㄒoㄒ)/~~

在上篇，我讲了一些作为开发需要知道的设计知识：什么是设备像素？什么是dpr？什么是DIPs？什么是viewport？虚拟viewport和布局viewport区别是什么？如果你还不是很清楚，可能需要[回过头](http://www.blackcater.win/2017/01/21/移动页面开发适配方案-上/)再看一遍了！

然后介绍了当下很多人使用的百分比布局，说明了为何我们不适用`vw`和`vh`，最后通过`em`引入了`rem`，进而解释了`rem`适配原理。

在下篇，我们介绍了如何去搭建自己的`rem`适配库，给出了`js`和css预编译各种版本代码。

然而，`less@2`不支持自定义函数，我们介绍了一些解决方案。这里大家可以自由选择自己喜欢的解决方案。

最后可耻的宣传一下自己写的库[flexible](https://github.com/blackcater/flexible)，欢迎大家star和提issue。
